trigger:
- nomain

pool:
  name: Default
  demands:
   - agent.name -equals local-pc 

stages:
- stage: stage1

  ## Jobs inside Stage
  jobs:

  ### CI Job
  - job: createStorage
    #### Steps inside the Job
    steps:

    # Install Python if not already installed
    - task: CmdLine@2
      name: InstallPython
      displayName: 'Install Python'
      inputs:
        script: |
          echo Installing Python...
          curl -o python-installer.exe https://www.python.org/ftp/python/3.9.6/python-3.9.6-amd64.exe
          python-installer.exe /quiet InstallAllUsers=1 PrependPath=1 /log install.log
          type install.log
          set "PATH=%PATH%;C:\Python39\Scripts;C:\Python39"

    # Install AWS CLI
    - task: CmdLine@2
      name: InstallAWSCLI
      displayName: 'Install AWS CLI'
      inputs:
        script: |
          echo Installing AWS CLI...
          curl "https://awscli.amazonaws.com/AWSCLIV2.msi" -o "AWSCLIV2.msi"
          msiexec.exe /i AWSCLIV2.msi /quiet
          set "PATH=%PATH%;C:\Program Files\Amazon\AWSCLIV2\"

    # Create S3 bucket
    - task: CmdLine@2
      name: createS3
      displayName: 'Create S3 bucket'
      inputs:
        script: |
          cd az-devops\aws-ep7
          C:\Python39\python -m venv env
          call env\Scripts\activate.bat
          C:\Python39\Scripts\pip install awscli
          set AWS_ACCESS_KEY_ID=%aws_id%
          set AWS_SECRET_ACCESS_KEY=%aws_access_key%
          aws s3api create-bucket --bucket dl-azdevops-ep7 --region us-east-1
          deactivate

  # CD Job
  - job: uploadJob
    dependsOn: createStorage
    #### Steps inside the Job
    steps:

    - task: CmdLine@2
      name: uploadToS3
      displayName: 'Upload files to S3 bucket'
      inputs:
        script: |
          cd az-devops\aws-ep7
          call env\Scripts\activate.bat
          C:\Python39\Scripts\pip install awscli
          set AWS_ACCESS_KEY_ID=%aws_id%
          set AWS_SECRET_ACCESS_KEY=%aws_access_key%
          aws s3 sync . s3://dl-azdevops-ep7
          deactivate
